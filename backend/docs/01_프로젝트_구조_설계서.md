# Hospital Admin Backend - 프로젝트 구조 설계서

## 1. 개요

### 1.1 프로젝트 정보
- **프로젝트명**: hospital-admin-api
- **프레임워크**: Spring Boot 3.2.x
- **Java 버전**: Java 17 (LTS)
- **빌드 도구**: Gradle 8.x
- **데이터베이스**: PostgreSQL 15+

### 1.2 아키텍처 개요
```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend                                 │
│                 (React + TypeScript + Vite)                     │
└─────────────────────────────┬───────────────────────────────────┘
                              │ REST API (JSON)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Spring Boot Application                       │
├─────────────────────────────────────────────────────────────────┤
│  Controller Layer    │  REST API 엔드포인트                      │
├──────────────────────┼──────────────────────────────────────────┤
│  Service Layer       │  비즈니스 로직                            │
├──────────────────────┼──────────────────────────────────────────┤
│  Repository Layer    │  데이터 접근 (Spring Data JPA)            │
├──────────────────────┼──────────────────────────────────────────┤
│  Entity Layer        │  도메인 모델                              │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      PostgreSQL Database                         │
│              (Multi-tenant with Row-Level Security)              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 기술 스택

### 2.1 핵심 의존성

| 구분 | 기술 | 버전 | 용도 |
|------|------|------|------|
| **Framework** | Spring Boot | 3.2.x | 애플리케이션 프레임워크 |
| **Language** | Java | 17 | 프로그래밍 언어 |
| **Build** | Gradle | 8.x | 빌드 도구 |
| **ORM** | Spring Data JPA | 3.2.x | 데이터 접근 |
| **Database** | PostgreSQL | 15+ | 관계형 데이터베이스 |
| **Security** | Spring Security | 6.x | 인증/인가 |
| **JWT** | jjwt | 0.12.x | JWT 토큰 처리 |
| **Validation** | Jakarta Validation | 3.0 | 입력 검증 |
| **API Docs** | SpringDoc OpenAPI | 2.3.x | API 문서화 |
| **Cache** | Spring Cache + Redis | - | 캐싱 |
| **Logging** | SLF4J + Logback | - | 로깅 |

### 2.2 개발/테스트 의존성

| 구분 | 기술 | 용도 |
|------|------|------|
| **Unit Test** | JUnit 5 | 단위 테스트 |
| **Mock** | Mockito | 모킹 프레임워크 |
| **Integration Test** | Spring Test | 통합 테스트 |
| **DB Test** | H2 | 인메모리 테스트 DB |
| **API Test** | RestAssured | API 테스트 |

---

## 3. 패키지 구조

```
src/main/java/kr/or/khnmc/hospitaladmin/
├── HospitalAdminApplication.java          # 메인 애플리케이션
│
├── common/                                 # 공통 모듈
│   ├── config/                            # 설정 클래스
│   │   ├── SecurityConfig.java            # Spring Security 설정
│   │   ├── JpaConfig.java                 # JPA 설정
│   │   ├── RedisConfig.java               # Redis 캐시 설정
│   │   ├── WebConfig.java                 # Web MVC 설정 (CORS 등)
│   │   └── SwaggerConfig.java             # OpenAPI 문서 설정
│   │
│   ├── exception/                         # 예외 처리
│   │   ├── GlobalExceptionHandler.java    # 전역 예외 핸들러
│   │   ├── BusinessException.java         # 비즈니스 예외
│   │   ├── UnauthorizedException.java     # 인증 예외
│   │   └── ErrorCode.java                 # 에러 코드 정의
│   │
│   ├── response/                          # 응답 형식
│   │   ├── ApiResponse.java               # 표준 API 응답
│   │   └── PageResponse.java              # 페이징 응답
│   │
│   ├── security/                          # 보안 모듈
│   │   ├── JwtTokenProvider.java          # JWT 토큰 생성/검증
│   │   ├── JwtAuthenticationFilter.java   # JWT 인증 필터
│   │   ├── CustomUserDetails.java         # 사용자 상세 정보
│   │   └── TenantContext.java             # 멀티테넌트 컨텍스트
│   │
│   └── util/                              # 유틸리티
│       ├── DateUtils.java
│       └── StringUtils.java
│
├── domain/                                 # 도메인 모듈
│   │
│   ├── auth/                              # 인증 도메인
│   │   ├── controller/
│   │   │   └── AuthController.java
│   │   ├── service/
│   │   │   └── AuthService.java
│   │   └── dto/
│   │       ├── LoginRequest.java
│   │       ├── LoginResponse.java
│   │       └── TokenRefreshRequest.java
│   │
│   ├── hospital/                          # 병원 도메인
│   │   ├── controller/
│   │   │   └── HospitalController.java
│   │   ├── service/
│   │   │   └── HospitalService.java
│   │   ├── repository/
│   │   │   └── HospitalRepository.java
│   │   ├── entity/
│   │   │   ├── Hospital.java
│   │   │   ├── HospitalSettings.java
│   │   │   └── Subscription.java
│   │   └── dto/
│   │       ├── HospitalDto.java
│   │       └── HospitalCreateRequest.java
│   │
│   ├── user/                              # 사용자 도메인
│   │   ├── controller/
│   │   │   └── UserController.java
│   │   ├── service/
│   │   │   └── UserService.java
│   │   ├── repository/
│   │   │   └── UserRepository.java
│   │   ├── entity/
│   │   │   ├── User.java
│   │   │   └── Role.java
│   │   └── dto/
│   │       ├── UserDto.java
│   │       └── UserCreateRequest.java
│   │
│   ├── exam/                              # 검사 관리 도메인
│   │   ├── controller/
│   │   │   ├── ExamGroupController.java
│   │   │   └── ExamMappingController.java
│   │   ├── service/
│   │   │   ├── ExamGroupService.java
│   │   │   └── ExamMappingService.java
│   │   ├── repository/
│   │   │   ├── ExamGroupRepository.java
│   │   │   └── ExamCodeMappingRepository.java
│   │   ├── entity/
│   │   │   ├── ExamGroup.java
│   │   │   └── ExamCodeMapping.java
│   │   └── dto/
│   │       ├── ExamGroupDto.java
│   │       ├── ExamMappingDto.java
│   │       └── ExamMappingUploadRequest.java
│   │
│   ├── prompt/                            # 프롬프트 관리 도메인
│   │   ├── controller/
│   │   │   └── PromptController.java
│   │   ├── service/
│   │   │   └── PromptService.java
│   │   ├── repository/
│   │   │   ├── PromptTemplateRepository.java
│   │   │   ├── HospitalPromptRepository.java
│   │   │   └── ExamHintRepository.java
│   │   ├── entity/
│   │   │   ├── PromptTemplate.java
│   │   │   ├── HospitalPrompt.java
│   │   │   └── ExamHint.java
│   │   └── dto/
│   │       ├── PromptDto.java
│   │       └── HintDto.java
│   │
│   ├── analysis/                          # AI 분석 도메인
│   │   ├── controller/
│   │   │   └── AnalysisController.java
│   │   ├── service/
│   │   │   └── AnalysisService.java
│   │   ├── repository/
│   │   │   ├── AnalysisSessionRepository.java
│   │   │   └── GroupAnalysisResultRepository.java
│   │   ├── entity/
│   │   │   ├── AnalysisSession.java
│   │   │   ├── GroupAnalysisResult.java
│   │   │   └── ExamResultSnapshot.java
│   │   └── dto/
│   │       ├── AnalysisSessionDto.java
│   │       └── AnalysisResultDto.java
│   │
│   └── ai/                                # AI 모델 관리 도메인
│       ├── controller/
│       │   └── AiModelController.java
│       ├── service/
│       │   └── AiModelService.java
│       ├── repository/
│       │   ├── AiModelRepository.java
│       │   └── HospitalAiConfigRepository.java
│       ├── entity/
│       │   ├── AiModel.java
│       │   └── HospitalAiConfig.java
│       └── dto/
│           └── AiModelDto.java
│
└── infra/                                  # 인프라 모듈
    ├── excel/                             # Excel 처리
    │   ├── ExcelParser.java
    │   └── ExamMappingExcelParser.java
    │
    └── external/                          # 외부 연동
        └── ollama/
            ├── OllamaClient.java
            └── OllamaResponse.java
```

---

## 4. 리소스 구조

```
src/main/resources/
├── application.yml                        # 기본 설정
├── application-dev.yml                    # 개발 환경 설정
├── application-prod.yml                   # 운영 환경 설정
├── application-test.yml                   # 테스트 환경 설정
│
├── db/
│   └── migration/                         # Flyway 마이그레이션
│       ├── V1__init_schema.sql
│       ├── V2__seed_data.sql
│       └── V3__add_indexes.sql
│
├── templates/                             # 이메일 템플릿 등
│   └── email/
│       └── welcome.html
│
└── static/                                # 정적 리소스
    └── docs/
        └── exam-mapping-template.xlsx     # Excel 업로드 템플릿
```

---

## 5. 설정 파일

### 5.1 build.gradle

```groovy
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.1'
    id 'io.spring.dependency-management' version '1.1.4'
}

group = 'kr.or.khnmc'
version = '1.0.0'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // Spring Boot Starters
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    // Database
    runtimeOnly 'org.postgresql:postgresql'
    implementation 'org.flywaydb:flyway-core'

    // JWT
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'

    // API Documentation
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'

    // Excel Processing
    implementation 'org.apache.poi:poi-ooxml:5.2.5'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

    // MapStruct (DTO 변환)
    implementation 'org.mapstruct:mapstruct:1.5.5.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.5.5.Final'

    // Test
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testRuntimeOnly 'com.h2database:h2'
    testImplementation 'io.rest-assured:rest-assured'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

### 5.2 application.yml

```yaml
spring:
  application:
    name: hospital-admin-api

  profiles:
    active: dev

  datasource:
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      idle-timeout: 30000
      connection-timeout: 20000

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
    open-in-view: false

  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  cache:
    type: redis

  data:
    redis:
      host: localhost
      port: 6379

server:
  port: 8080
  servlet:
    context-path: /api

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-here-for-development}
  access-token-validity: 3600000       # 1 hour
  refresh-token-validity: 604800000    # 7 days

# OpenAPI Configuration
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha

# Logging
logging:
  level:
    kr.or.khnmc: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
```

### 5.3 application-dev.yml

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/hospital_admin_dev
    username: postgres
    password: postgres

  jpa:
    show-sql: true

  data:
    redis:
      host: localhost
      port: 6379

logging:
  level:
    root: INFO
    kr.or.khnmc: DEBUG
```

### 5.3 application-prod.yml

```yaml
spring:
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    hikari:
      maximum-pool-size: 20

  jpa:
    show-sql: false

  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}

jwt:
  secret: ${JWT_SECRET}

logging:
  level:
    root: WARN
    kr.or.khnmc: INFO
```

---

## 6. 핵심 컴포넌트 설계

### 6.1 멀티테넌트 컨텍스트

```java
@Component
public class TenantContext {
    private static final ThreadLocal<UUID> currentHospitalId = new ThreadLocal<>();

    public static void setCurrentHospitalId(UUID hospitalId) {
        currentHospitalId.set(hospitalId);
    }

    public static UUID getCurrentHospitalId() {
        return currentHospitalId.get();
    }

    public static void clear() {
        currentHospitalId.remove();
    }
}
```

### 6.2 BaseEntity

```java
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
@Getter
public abstract class BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

### 6.3 표준 API 응답

```java
@Getter
@Builder
public class ApiResponse<T> {
    private final boolean success;
    private final String message;
    private final T data;
    private final LocalDateTime timestamp;

    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
            .success(true)
            .data(data)
            .timestamp(LocalDateTime.now())
            .build();
    }

    public static <T> ApiResponse<T> success(String message, T data) {
        return ApiResponse.<T>builder()
            .success(true)
            .message(message)
            .data(data)
            .timestamp(LocalDateTime.now())
            .build();
    }

    public static ApiResponse<Void> error(String message) {
        return ApiResponse.<Void>builder()
            .success(false)
            .message(message)
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

---

## 7. 환경별 배포

### 7.1 Docker 설정

```dockerfile
# Dockerfile
FROM eclipse-temurin:17-jdk-alpine AS builder
WORKDIR /app
COPY . .
RUN ./gradlew bootJar

FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 7.2 Docker Compose (개발)

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: hospital_admin_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/hospital_admin_dev
      SPRING_DATA_REDIS_HOST: redis
    depends_on:
      - postgres
      - redis

volumes:
  postgres_data:
```

---

## 8. 개발 가이드라인

### 8.1 명명 규칙

| 구분 | 규칙 | 예시 |
|------|------|------|
| 클래스 | PascalCase | `UserService`, `HospitalController` |
| 메서드 | camelCase | `findByHospitalId`, `createUser` |
| 변수 | camelCase | `hospitalId`, `userName` |
| 상수 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT`, `DEFAULT_PAGE_SIZE` |
| 패키지 | lowercase | `kr.or.khnmc.hospitaladmin.domain.user` |
| 테이블 | snake_case | `exam_code_mappings`, `analysis_sessions` |
| 컬럼 | snake_case | `hospital_id`, `created_at` |

### 8.2 계층별 규칙

| 계층 | 역할 | 규칙 |
|------|------|------|
| **Controller** | HTTP 요청/응답 처리 | 비즈니스 로직 금지, DTO만 사용 |
| **Service** | 비즈니스 로직 | 트랜잭션 관리, Entity ↔ DTO 변환 |
| **Repository** | 데이터 접근 | JPQL/QueryDSL 사용, Native Query 최소화 |
| **Entity** | 도메인 모델 | 비즈니스 로직 포함 가능, Setter 지양 |
| **DTO** | 데이터 전송 | 불변 객체 권장, 검증 어노테이션 |

### 8.3 테스트 규칙

- 단위 테스트: Service, Repository 계층
- 통합 테스트: Controller 계층 (MockMvc 또는 RestAssured)
- 테스트 커버리지 목표: 80% 이상

---

**문서 버전**: 1.0
**작성일**: 2025-12-10
**작성자**: Claude AI
